name: Sync All APK & Push Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip jq coreutils opencc python3 python3-pip
          pip3 install requests

# ───────────────────── FongMi 蜂蜜版 ─────────────────────
      - name: 下载 FongMi APK
        run: |
          curl -L -o fongmi.zip https://codeload.github.com/FongMi/Release/zip/refs/heads/fongmi
          unzip -q fongmi.zip
          mkdir -p apk/fongmi
          find Release-fongmi/apk -type f -name "*.apk" -exec cp {} apk/fongmi/ \;

      - name: 解析 FongMi 更新日志
        run: |
          curl -s -o leanback.json https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/leanback.json
          curl -s -o mobile.json https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/mobile.json
          ver=$(jq -r '.name' leanback.json)
          logs=$(jq -r '.desc' leanback.json mobile.json | sed 's/^\* //g' | sort -u | sed 's/^/• /g' | opencc -c t2s.json)
          time=$(TZ=Asia/Shanghai date '+%Y/%m/%d %H:%M')
          cat <<EOF >> $GITHUB_ENV
caption_fongmi<<EOT

 - 影视 · 蜂蜜版

- 本次更新：
$logs

 - 当前版本：$ver
 - 更新时间：$time
EOT
EOF

# ───────────────────── OK影视（修正版） ─────────────────────
      - name: 下载 OK影视 APK（支持无提取码）
        env:
          QUARK_COOKIE: ${{ secrets.QUARK_COOKIE }}
          QUARK_PASSCODE: ${{ secrets.QUARK_PASSCODE }}
        run: |
          mkdir -p apk/ok/pro apk/ok/standard
          python3 <<'EOF'
import os, requests, json

headers = {
    'Cookie': os.environ['QUARK_COOKIE'],
    'User-Agent': 'Mozilla/5.0',
    'Content-Type': 'application/json'
}

pwd_id = 'cb0ee2b9ac64'
raw_passcode = os.environ.get('QUARK_PASSCODE', '')
passcode = '' if raw_passcode.lower() in ('none', 'null', '') else raw_passcode

def post(url, data):
    r = requests.post(url, headers=headers, data=json.dumps(data)).json()
    if r.get('code') != 0:
        raise SystemExit(r)
    return r['data']

token_data = post(
    'https://pan.quark.cn/api/share/v2/share/token',
    {"pwd_id": pwd_id, "passcode": passcode}
)

def list_dir(fid):
    return post(
        'https://pan.quark.cn/api/share/v2/share/list',
        {"pwd_id": pwd_id, "token": token_data['token'], "stoken": token_data['stoken'], "pdir_fid": fid}
    )['list']

def download(fid, path):
    d = post(
        'https://pan.quark.cn/api/share/v2/share/download',
        {"pwd_id": pwd_id, "fid_list": [fid], "stoken": token_data['stoken'], "passcode": passcode}
    )[0]
    r = requests.get(d['download_url'], stream=True)
    with open(path, 'wb') as f:
        for c in r.iter_content(8192):
            f.write(c)

root = list_dir("0")
pro = next(i for i in root if i['file_name']=='OK影视Pro版')
std = next(i for i in root if i['file_name']=='OK影视标准版')

for f in list_dir(pro['fid']):
    if f['file_name'].endswith('.apk'):
        download(f['fid'], f"apk/ok/pro/{f['file_name']}")
    if f['file_name'].endswith('.txt'):
        download(f['fid'], "apk/ok/pro.txt")

subs = [i for i in list_dir(std['fid']) if i['dir'] and i['file_name'].isdigit()]
latest = max(subs, key=lambda x:int(x['file_name']))
for f in list_dir(latest['fid']):
    if f['file_name'].endswith('.apk'):
        download(f['fid'], f"apk/ok/standard/{f['file_name']}")
    if f['file_name'].endswith('.txt'):
        download(f['fid'], "apk/ok/standard.txt")
EOF
